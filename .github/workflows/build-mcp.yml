# Ovo — Build MCP Server Binaries (cross-platform SEA)
# Builds standalone single-executable binaries for Linux, macOS, and Windows
# on every push to main. Attaches to the rolling release tagged by commit hash.
# SPDX-License-Identifier: GPL-3.0

name: Build MCP Binaries

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # ── Native builds (runner arch == target arch) ──
          - os: ubuntu-latest
            label: linux-x64
            binary: ovo-mcp
            ext: ""
            cross: false
          - os: ubuntu-24.04-arm
            label: linux-arm64
            binary: ovo-mcp
            ext: ""
            cross: false
          - os: macos-latest
            label: darwin-arm64
            binary: ovo-mcp
            ext: ""
            cross: false
          - os: macos-15-intel
            label: darwin-x64
            binary: ovo-mcp
            ext: ""
            cross: false
          - os: windows-latest
            label: win-x64
            binary: ovo-mcp.exe
            ext: ".exe"
            cross: false
          # ── Cross-compiled (inject blob into downloaded Node binary) ──
          - os: ubuntu-latest
            label: win-arm64
            binary: ovo-mcp.exe
            ext: ".exe"
            cross: true
            node_url: "https://nodejs.org/dist/v22.15.0/node-v22.15.0-win-arm64.zip"
            node_bin_path: "node-v22.15.0-win-arm64/node.exe"

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ── Bundle with esbuild ──
      - name: Bundle MCP server
        run: pnpm --filter @ovo/mcp build:bundle

      # ── Generate SEA blob (useCodeCache=false for cross builds) ──
      - name: Generate SEA blob
        working-directory: apps/mcp
        run: node --experimental-sea-config sea-config.json
        env:
          # Cross-compiled blobs can't use code cache or snapshots
          NODE_OPTIONS: ""

      # ── Create executable (Linux — native) ──
      - name: Create executable (Linux native)
        if: runner.os == 'Linux' && matrix.cross == false
        working-directory: apps/mcp
        run: |
          cp $(command -v node) "dist/${{ matrix.binary }}"
          npx postject "dist/${{ matrix.binary }}" NODE_SEA_BLOB dist/ovo-mcp.blob \
            --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2
          chmod +x "dist/${{ matrix.binary }}"

      # ── Create executable (macOS) ──
      - name: Create executable (macOS)
        if: runner.os == 'macOS'
        working-directory: apps/mcp
        run: |
          cp $(command -v node) "dist/${{ matrix.binary }}"
          codesign --remove-signature "dist/${{ matrix.binary }}"
          npx postject "dist/${{ matrix.binary }}" NODE_SEA_BLOB dist/ovo-mcp.blob \
            --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2 \
            --macho-segment-name NODE_SEA
          codesign --sign - "dist/${{ matrix.binary }}"
          chmod +x "dist/${{ matrix.binary }}"

      # ── Create executable (Windows — native) ──
      - name: Create executable (Windows native)
        if: runner.os == 'Windows' && matrix.cross == false
        working-directory: apps/mcp
        shell: pwsh
        run: |
          $nodePath = (Get-Command node).Source
          Copy-Item $nodePath "dist/${{ matrix.binary }}"
          try {
            signtool remove /s "dist/${{ matrix.binary }}" 2>$null
          } catch {
            Write-Host "Skipping signature removal (signtool not available)"
          }
          npx postject "dist/${{ matrix.binary }}" NODE_SEA_BLOB dist/ovo-mcp.blob `
            --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2

      # ── Create executable (cross-compiled — download target Node binary) ──
      - name: Download target Node binary
        if: matrix.cross == true
        working-directory: apps/mcp
        run: |
          curl -fsSL "${{ matrix.node_url }}" -o node-target.zip
          unzip -q node-target.zip

      - name: Create executable (cross-compiled)
        if: matrix.cross == true
        working-directory: apps/mcp
        run: |
          cp "${{ matrix.node_bin_path }}" "dist/${{ matrix.binary }}"
          npx postject "dist/${{ matrix.binary }}" NODE_SEA_BLOB dist/ovo-mcp.blob \
            --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2
          chmod +x "dist/${{ matrix.binary }}" 2>/dev/null || true

      # ── Rename with commit hash ──
      - name: Rename binary
        id: rename
        shell: bash
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          SRC="apps/mcp/dist/${{ matrix.binary }}"
          DEST="apps/mcp/dist/ovo-mcp-${{ matrix.label }}-${SHORT_SHA}${{ matrix.ext }}"
          mv "$SRC" "$DEST"
          echo "artifact_path=$DEST" >> "$GITHUB_OUTPUT"
          echo "artifact_name=ovo-mcp-${{ matrix.label }}-${SHORT_SHA}${{ matrix.ext }}" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ovo-mcp-${{ matrix.label }}
          path: ${{ steps.rename.outputs.artifact_path }}
          retention-days: 30
          if-no-files-found: error

  release:
    name: Attach to Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: mcp-binaries
          merge-multiple: true

      - name: Get short SHA
        id: sha
        run: echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: List binaries
        run: ls -lh mcp-binaries/

      # Upload to existing release (created by build-apk.yml) or create new one
      # Uses append_body so APK and MCP workflows don't overwrite each other
      - name: Attach to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.sha.outputs.short_sha }}
          name: Ovo (${{ steps.sha.outputs.short_sha }})
          append_body: true
          body: |
            **Build from [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})**

            ### MCP Server Binaries
            Standalone executables — no Node.js installation required.

            | Platform | File |
            |----------|------|
            | Linux x64 | `ovo-mcp-linux-x64-${{ steps.sha.outputs.short_sha }}` |
            | Linux arm64 | `ovo-mcp-linux-arm64-${{ steps.sha.outputs.short_sha }}` |
            | macOS Apple Silicon | `ovo-mcp-darwin-arm64-${{ steps.sha.outputs.short_sha }}` |
            | macOS Intel | `ovo-mcp-darwin-x64-${{ steps.sha.outputs.short_sha }}` |
            | Windows x64 | `ovo-mcp-win-x64-${{ steps.sha.outputs.short_sha }}.exe` |
            | Windows arm64 | `ovo-mcp-win-arm64-${{ steps.sha.outputs.short_sha }}.exe` |

            ---
          files: mcp-binaries/*
          generate_release_notes: true
