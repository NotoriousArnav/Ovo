# Ovo — Build Android APKs (multi-arch, rolling release)
# Builds per-architecture release APKs on every push to main
# Tags releases by commit hash (rolling release model)
# SPDX-License-Identifier: GPL-3.0

name: Build APK

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  EXPO_PUBLIC_API_URL: https://ovo-backend.vercel.app

jobs:
  build:
    name: Build Android APKs
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: apps/mobile

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Write .env
        run: echo "EXPO_PUBLIC_API_URL=${{ env.EXPO_PUBLIC_API_URL }}" > .env

      - name: Expo prebuild
        run: npx expo prebuild --platform android --clean

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # ── Signing (optional — configure secrets for signed builds) ──
      - name: Decode keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/upload.keystore

      - name: Configure signing
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cat >> android/gradle.properties <<EOF
          MYAPP_UPLOAD_STORE_FILE=upload.keystore
          MYAPP_UPLOAD_KEY_ALIAS=$ANDROID_KEY_ALIAS
          MYAPP_UPLOAD_STORE_PASSWORD=$ANDROID_KEYSTORE_PASSWORD
          MYAPP_UPLOAD_KEY_PASSWORD=$ANDROID_KEY_PASSWORD
          EOF

      # ── Enable ABI splits for per-architecture APKs ──
      - name: Configure ABI splits
        run: |
          cat >> android/app/build.gradle <<'SPLITS'

          // ── Per-architecture APK splits (added by CI) ──
          android {
              splits {
                  abi {
                      enable true
                      reset()
                      include "arm64-v8a", "armeabi-v7a", "x86_64", "x86"
                      universalApk true
                  }
              }
          }
          SPLITS

      # ── Build ──
      - name: Build Release APKs
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx4g -XX:+HeapDumpOnOutOfMemoryError"

      # ── Rename APKs to ovo-<arch>-<hash>-release.apk ──
      - name: Rename APKs
        id: rename
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          APK_DIR="android/app/build/outputs/apk/release"
          OUT_DIR="android/app/build/outputs/apk/renamed"
          mkdir -p "$OUT_DIR"

          # Map Gradle ABI split filenames to architecture labels
          for apk in "$APK_DIR"/*.apk; do
            filename=$(basename "$apk")
            case "$filename" in
              *arm64-v8a*)   arch="arm64-v8a" ;;
              *armeabi-v7a*) arch="armeabi-v7a" ;;
              *x86_64*)      arch="x86_64" ;;
              *x86*)         arch="x86" ;;
              *universal*)   arch="universal" ;;
              *)             arch="universal" ;;
            esac
            dest="$OUT_DIR/ovo-${arch}-${SHORT_SHA}-release.apk"
            cp "$apk" "$dest"
            echo "Renamed: $filename -> $(basename "$dest")"
          done

          echo "apk_dir=$OUT_DIR" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ovo-${{ steps.rename.outputs.short_sha }}-apks
          path: apps/mobile/${{ steps.rename.outputs.apk_dir }}/*.apk
          retention-days: 30
          if-no-files-found: error

      # ── GitHub Release (rolling — tagged by commit hash) ──
      # Uses append_body so APK and MCP workflows don't overwrite each other
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rename.outputs.short_sha }}
          name: Ovo (${{ steps.rename.outputs.short_sha }})
          append_body: true
          body: |
            **Build from [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})**

            ### Android APKs
            Architectures: `arm64-v8a` · `armeabi-v7a` · `x86_64` · `x86` · `universal`

            Download the APK matching your device architecture, or use `universal` if unsure.

            ---
          files: apps/mobile/${{ steps.rename.outputs.apk_dir }}/*.apk
          generate_release_notes: true
